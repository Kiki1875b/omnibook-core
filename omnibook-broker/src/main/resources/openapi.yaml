openapi: 3.0.3
info:
  title: Omnibook Broker API
  description: 외부 OTA 플랫폼 이벤트 수신 및 처리를 위한 API
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: 로컬 개발 서버

tags:
  - name: Events
    description: 이벤트 수신 API
  - name: Reservations
    description: 예약 조회 API
  - name: Inventory
    description: 재고 조회 API
  - name: Idempotency
    description: 멱등성 레지스트리 API
  - name: Reconciliation
    description: 대사 리포트 API

paths:
  /api/events:
    post:
      tags:
        - Events
      summary: 외부 이벤트 수신
      description: |
        외부 OTA 플랫폼(야놀자, 에어비앤비, 여기어때)에서 발생한 이벤트를 수신합니다.
        - 정상 처리 시 ACCEPTED 상태 반환
        - 변환 실패 시 원본을 저장하고 SAVED_FOR_RETRY 상태 반환
      operationId: receiveEvent
      parameters:
        - name: X-Event-Id
          in: header
          required: false
          description: 이벤트 고유 ID (미제공 시 서버에서 생성)
          schema:
            type: string
            example: "evt-12345"
        - name: X-Platform
          in: header
          required: true
          description: |
            이벤트 발생 플랫폼
            - YANOLJA 또는 A: 야놀자
            - AIRBNB 또는 B: 에어비앤비
            - YEOGIEOTTAE 또는 C: 여기어때
          schema:
            type: string
            enum:
              - YANOLJA
              - A
              - AIRBNB
              - B
              - YEOGIEOTTAE
              - C
            example: "YANOLJA"
        - name: X-Event-Type
          in: header
          required: false
          description: |
            이벤트 타입 (기본값: BOOKING)
            - BOOKING: 예약 이벤트
            - CANCELLATION 또는 CANCEL: 취소 이벤트
          schema:
            type: string
            default: "BOOKING"
            enum:
              - BOOKING
              - CANCELLATION
              - CANCEL
            example: "BOOKING"
        - name: X-Correlation-Id
          in: header
          required: false
          description: 요청 추적을 위한 상관관계 ID
          schema:
            type: string
            example: "corr-abc-123"
      requestBody:
        required: true
        description: 이벤트 요청 바디
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncomingEventRequest'
            examples:
              yanolja_booking:
                summary: 야놀자 예약 이벤트
                value:
                  eventId: "evt-001"
                  reservationId: "res-001"
                  payload:
                    reservationId: "YNJ-abc123"
                    roomId: "room-001"
                    roomName: "디럭스 더블"
                    accommodationName: "서울 호텔"
                    accommodationAddress: "서울시 강남구"
                    checkInDate: "2025-03-01"
                    checkOutDate: "2025-03-03"
                    stayNights: 2
                    guestName: "홍길동"
                    guestPhone: "010-1234-5678"
                    couponCode: "WELCOME10"
                    discountAmount: 10000
                    totalPrice: 200000
                    paymentMethod: "CARD"
                    status: "예약완료"
                    bookedAt: "2025-02-01T10:30:00"
                    platform: "YANOLJA"
              airbnb_booking:
                summary: 에어비앤비 예약 이벤트
                value:
                  eventId: "evt-002"
                  reservationId: "res-002"
                  payload:
                    confirmationCode: "ABC123XYZW"
                    listingId: "listing-001"
                    listingName: "Cozy Studio in Seoul"
                    listingAddress: "Seoul, Gangnam"
                    checkIn: "2025-03-01"
                    checkOut: "2025-03-03"
                    nights: 2
                    guestFirstName: "John"
                    guestLastName: "Doe"
                    guestEmail: "john.doe@example.com"
                    numberOfGuests: 2
                    numberOfAdults: 2
                    numberOfChildren: 0
                    numberOfInfants: 0
                    totalPayout: 150000.0
                    hostServiceFee: 5000.0
                    guestServiceFee: 3000.0
                    cleaningFee: 10000.0
                    currency: "KRW"
                    status: "ACCEPTED"
                    cancellationPolicy: "FLEXIBLE"
                    timezone: "Asia/Seoul"
                    createdAt: 1706745000000
                    updatedAt: 1706745000000
              yeogieottae_booking:
                summary: 여기어때 예약 이벤트
                value:
                  eventId: "evt-003"
                  reservationId: "res-003"
                  payload:
                    orderId: "YEO-abc123"
                    accommodationId: "acc-001"
                    accommodationName: "부산 호텔"
                    accommodationAddress: "부산시 해운대구"
                    roomTypeId: "room-type-001"
                    roomTypeName: "스탠다드"
                    startDate: "20250301"
                    endDate: "20250303"
                    buyerName: "김철수"
                    buyerTel: "010-9876-5432"
                    totalAmount: 180000
                    payMethod: "CARD"
                    state: 1
                    registeredTs: 1706745000
                    lastModifiedTs: 1706745000
      responses:
        '200':
          description: 이벤트 정상 처리됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
              example:
                eventId: "evt-12345"
                status: "ACCEPTED"
                message: "이벤트가 정상 처리되었습니다."
        '202':
          description: 이벤트 저장됨 (재처리 필요)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventResponse'
              example:
                eventId: "evt-12345"
                status: "SAVED_FOR_RETRY"
                message: "변환 실패. 원본이 저장되었습니다."
    get:
      tags:
        - Events
      summary: 이벤트 목록 조회
      description: |
        시스템에 수신된 이벤트 목록을 조회합니다.
        운영 모니터링용 API로, 시간축 기반 시스템 상태를 파악합니다.

        활용 예시:
        - DUPLICATE 폭증 여부 확인
        - 특정 플랫폼의 이상 패턴 감지
        - 특정 시간대 대량 실패 분석
      operationId: getEvents
      parameters:
        - name: platform
          in: query
          required: false
          description: 플랫폼 필터
          schema:
            type: string
            enum:
              - YANOLJA
              - AIRBNB
              - YEOGIEOTTAE
        - name: eventType
          in: query
          required: false
          description: 이벤트 타입 필터
          schema:
            type: string
            enum:
              - BOOKING
              - CANCELLATION
        - name: processResult
          in: query
          required: false
          description: 처리 결과 필터
          schema:
            type: string
            enum:
              - OK
              - DUPLICATE
              - REJECTED
              - ERROR
        - name: from
          in: query
          required: false
          description: 조회 시작 시각 (ISO-8601)
          schema:
            type: string
            format: date-time
            example: "2025-02-01T00:00:00Z"
        - name: to
          in: query
          required: false
          description: 조회 종료 시각 (ISO-8601)
          schema:
            type: string
            format: date-time
            example: "2025-02-01T23:59:59Z"
        - name: platformRoomId
          in: query
          required: false
          description: 플랫폼 객실 ID 필터
          schema:
            type: string
            example: "room-001"
        - name: reservationId
          in: query
          required: false
          description: 예약 ID 필터
          schema:
            type: string
            example: "YNJ-abc123"
        - name: page
          in: query
          required: false
          description: 페이지 번호 (0부터 시작)
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: size
          in: query
          required: false
          description: 페이지 크기
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventListResponse'
              example:
                content:
                  - eventId: "evt-12345"
                    platform: "YANOLJA"
                    eventType: "BOOKING"
                    processResult: "OK"
                    reservationId: "YNJ-abc123"
                    platformRoomId: "room-001"
                    receivedAt: "2025-02-01T10:30:00Z"
                  - eventId: "evt-12346"
                    platform: "YANOLJA"
                    eventType: "BOOKING"
                    processResult: "DUPLICATE"
                    reservationId: "YNJ-abc123"
                    platformRoomId: "room-001"
                    receivedAt: "2025-02-01T10:35:00Z"
                  - eventId: "evt-12347"
                    platform: "AIRBNB"
                    eventType: "CANCELLATION"
                    processResult: "ERROR"
                    reservationId: null
                    platformRoomId: "listing-001"
                    receivedAt: "2025-02-01T11:00:00Z"
                page: 0
                size: 20
                totalElements: 156
                totalPages: 8

  /api/events/{eventId}:
    get:
      tags:
        - Events
      summary: 이벤트 처리 결과 조회
      description: |
        특정 이벤트가 시스템에 어떤 영향을 미쳤는지 조회합니다.
        - 원본 payload
        - 처리 결과 및 시각
        - 영향받은 예약
        - 콜백 전송 상태
      operationId: getEventDetail
      parameters:
        - name: eventId
          in: path
          required: true
          description: 이벤트 ID
          schema:
            type: string
            example: "evt-12345"
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EventDetailResponse'
              examples:
                success:
                  summary: 정상 처리된 이벤트
                  value:
                    eventId: "evt-12345"
                    platform: "YANOLJA"
                    eventType: "BOOKING"
                    payload:
                      reservationId: "YNJ-abc123"
                      roomId: "room-001"
                      checkInDate: "2025-03-01"
                      checkOutDate: "2025-03-03"
                      guestName: "홍길동"
                      totalPrice: 200000
                      status: "예약완료"
                    receivedAt: "2025-02-01T10:30:00Z"
                    processedAt: "2025-02-01T10:30:01Z"
                    processResult: "OK"
                    reservationId: "YNJ-abc123"
                    outboxStatus: "SENT"
                duplicate:
                  summary: 중복 이벤트
                  value:
                    eventId: "evt-12346"
                    platform: "YANOLJA"
                    eventType: "BOOKING"
                    payload:
                      reservationId: "YNJ-abc123"
                      roomId: "room-001"
                      checkInDate: "2025-03-01"
                      checkOutDate: "2025-03-03"
                      guestName: "홍길동"
                      totalPrice: 200000
                      status: "예약완료"
                    receivedAt: "2025-02-01T10:35:00Z"
                    processedAt: "2025-02-01T10:35:00Z"
                    processResult: "DUPLICATE"
                    reservationId: "YNJ-abc123"
                    outboxStatus: null
                error:
                  summary: 처리 실패 이벤트
                  value:
                    eventId: "evt-12347"
                    platform: "YANOLJA"
                    eventType: "BOOKING"
                    payload:
                      reservationId: "YNJ-xyz999"
                      roomId: "room-invalid"
                      checkInDate: "2025-03-01"
                      checkOutDate: "2025-03-03"
                    receivedAt: "2025-02-01T11:00:00Z"
                    processedAt: "2025-02-01T11:00:02Z"
                    processResult: "ERROR"
                    errorMessage: "존재하지 않는 객실: room-invalid"
                    reservationId: null
                    outboxStatus: null
        '404':
          description: 이벤트를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "EVENT_NOT_FOUND"
                reason: "이벤트를 찾을 수 없습니다."
                details:
                  eventId: "evt-99999"
                timestamp: "2025-02-01T10:30:00Z"
                traceId: "abc-123-xyz"

  /api/reservations/{reservationId}:
    get:
      tags:
        - Reservations
      summary: 예약 상태 조회
      description: 특정 예약의 현재 상태를 조회합니다.
      operationId: getReservationStatus
      parameters:
        - name: reservationId
          in: path
          required: true
          description: 예약 ID
          schema:
            type: string
            example: "YNJ-abc123"
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReservationStatusResponse'
              example:
                reservationId: "YNJ-abc123"
                platform: "YANOLJA"
                status: "CONFIRMED"
                roomId: "room-001"
                propertyName: "서울 호텔"
                checkIn: "2025-03-01"
                checkOut: "2025-03-03"
                guestName: "홍길동"
                totalAmount: 200000
                createdAt: "2025-02-01T10:30:00Z"
                updatedAt: "2025-02-01T10:30:00Z"
        '404':
          description: 예약을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "RESERVATION_NOT_FOUND"
                reason: "예약을 찾을 수 없습니다."
                details:
                  reservationId: "YNJ-abc123"
                timestamp: "2025-02-01T10:30:00Z"
                traceId: "abc-123-xyz"

  /api/reservations/{reservationId}/history:
    get:
      tags:
        - Reservations
      summary: 예약 히스토리 조회
      description: |
        특정 예약에 대한 처리 히스토리를 조회합니다.
        - 상태 변경 이력
        - 이벤트 처리 성공/실패 이력
        - 시간순 정렬 (최신순)
      operationId: getReservationHistory
      parameters:
        - name: reservationId
          in: path
          required: true
          description: 예약 ID
          schema:
            type: string
            example: "YNJ-abc123"
      responses:
        '200':
          description: 히스토리 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReservationHistoryResponse'
              example:
                reservationId: "YNJ-abc123"
                platform: "YANOLJA"
                currentStatus: "CANCELLED"
                history:
                  - eventId: "evt-002"
                    eventType: "CANCELLATION"
                    result: "SUCCESS"
                    previousStatus: "CONFIRMED"
                    newStatus: "CANCELLED"
                    errorMessage: null
                    occurredAt: "2025-02-05T14:30:00Z"
                  - eventId: "evt-001"
                    eventType: "BOOKING"
                    result: "SUCCESS"
                    previousStatus: null
                    newStatus: "CONFIRMED"
                    errorMessage: null
                    occurredAt: "2025-02-01T10:30:00Z"
        '404':
          description: 예약을 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "RESERVATION_NOT_FOUND"
                reason: "예약을 찾을 수 없습니다."
                details:
                  reservationId: "YNJ-abc123"
                timestamp: "2025-02-01T10:30:00Z"
                traceId: "abc-123-xyz"

  /api/inventory:
    get:
      tags:
        - Inventory
      summary: 재고 조회
      description: |
        특정 객실의 날짜별 재고를 조회합니다.
        - 객실-날짜당 총 재고는 1개
        - 재고가 없는 날짜는 available: 0으로 표시
      operationId: getInventory
      parameters:
        - name: roomId
          in: query
          required: true
          description: 객실 ID
          schema:
            type: string
            example: "room-001"
        - name: startDate
          in: query
          required: false
          description: 조회 시작일
          schema:
            type: string
            format: date
            example: "2025-03-01"
        - name: endDate
          in: query
          required: false
          description: 조회 종료일
          schema:
            type: string
            format: date
            example: "2025-03-07"
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventoryResponse'
              example:
                roomId: "room-001"
                startDate: "2025-03-01"
                endDate: "2025-03-07"
                inventory:
                  - date: "2025-03-01"
                    total: 1
                    booked: 1
                    available: 0
                  - date: "2025-03-02"
                    total: 1
                    booked: 0
                    available: 1
                  - date: "2025-03-03"
                    total: 1
                    booked: 0
                    available: 1
                  - date: "2025-03-04"
                    total: 1
                    booked: 1
                    available: 0
                  - date: "2025-03-05"
                    total: 1
                    booked: 0
                    available: 1
                  - date: "2025-03-06"
                    total: 1
                    booked: 0
                    available: 1
                  - date: "2025-03-07"
                    total: 1
                    booked: 0
                    available: 1
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "INVALID_DATE_RANGE"
                reason: "종료일은 시작일보다 이후여야 합니다."
                details:
                  startDate: "2025-03-10"
                  endDate: "2025-03-01"
                timestamp: "2025-02-01T10:30:00Z"
                traceId: "abc-123-xyz"

  /api/idempotency/{eventId}:
    get:
      tags:
        - Idempotency
      summary: 멱등성 키 조회
      description: |
        이 eventId가 이미 효과를 냈는지 확인합니다.
        Exactly-once 보장을 위한 증거 레지스트리입니다.

        이벤트 테이블 조회가 아닌, 멱등성 보장 여부를 확인하는 API입니다.
      operationId: getIdempotencyKey
      parameters:
        - name: eventId
          in: path
          required: true
          description: 이벤트 ID
          schema:
            type: string
            example: "evt-12345"
      responses:
        '200':
          description: 조회 성공 (이미 처리됨)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IdempotencyResponse'
              examples:
                confirmed:
                  summary: 정상 처리된 이벤트
                  value:
                    eventId: "evt-12345"
                    firstProcessedAt: "2025-02-01T10:30:00Z"
                    result: "CONFIRMED"
                    reservationId: "YNJ-abc123"
                    resultHash: "a1b2c3d4e5f6..."
                rejected:
                  summary: 거부된 이벤트
                  value:
                    eventId: "evt-12346"
                    firstProcessedAt: "2025-02-01T10:35:00Z"
                    result: "REJECTED"
                    reservationId: null
                    resultHash: "f6e5d4c3b2a1..."
                ignored:
                  summary: 무시된 이벤트 (중복)
                  value:
                    eventId: "evt-12347"
                    firstProcessedAt: "2025-02-01T10:40:00Z"
                    result: "IGNORED"
                    reservationId: "YNJ-abc123"
                    resultHash: "1a2b3c4d5e6f..."
        '404':
          description: 처리된 적 없음 (멱등성 키 없음)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "IDEMPOTENCY_KEY_NOT_FOUND"
                reason: "처리된 적 없는 이벤트입니다."
                details:
                  eventId: "evt-99999"
                timestamp: "2025-02-01T10:30:00Z"
                traceId: "abc-123-xyz"

  /api/reconciliation/{platform}:
    get:
      tags:
        - Reconciliation
      summary: 플랫폼별 대사 리포트
      description: |
        특정 플랫폼의 예약 데이터와 시스템 내부 데이터 간의 불일치를 조회합니다.

        대사 항목:
        - 플랫폼에만 있고 시스템에 없는 건 (누락)
        - 시스템에만 있고 플랫폼에 없는 건 (유령)
        - 금액 불일치
        - 상태 불일치
        - 날짜 불일치
      operationId: getReconciliationReport
      parameters:
        - name: platform
          in: path
          required: true
          description: 플랫폼
          schema:
            type: string
            enum:
              - YANOLJA
              - AIRBNB
              - YEOGIEOTTAE
            example: "YANOLJA"
        - name: from
          in: query
          required: true
          description: 조회 시작일
          schema:
            type: string
            format: date
            example: "2025-02-01"
        - name: to
          in: query
          required: true
          description: 조회 종료일
          schema:
            type: string
            format: date
            example: "2025-02-28"
      responses:
        '200':
          description: 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReconciliationResponse'
              example:
                platform: "YANOLJA"
                period:
                  from: "2025-02-01"
                  to: "2025-02-28"
                summary:
                  totalPlatformRecords: 150
                  totalSystemRecords: 148
                  matchedCount: 145
                  discrepancyCount: 5
                  byType:
                    MISSING_IN_SYSTEM: 2
                    MISSING_IN_PLATFORM: 0
                    AMOUNT_MISMATCH: 1
                    STATUS_MISMATCH: 2
                    DATE_MISMATCH: 0
                discrepancies:
                  - type: "MISSING_IN_SYSTEM"
                    platformReservationId: "YNJ-missing01"
                    systemReservationId: null
                    platformData:
                      checkIn: "2025-02-10"
                      checkOut: "2025-02-12"
                      totalAmount: 200000
                      status: "예약완료"
                    systemData: null
                    detectedAt: "2025-02-28T10:00:00Z"
                  - type: "AMOUNT_MISMATCH"
                    platformReservationId: "YNJ-abc123"
                    systemReservationId: "YNJ-abc123"
                    platformData:
                      totalAmount: 200000
                    systemData:
                      totalAmount: 180000
                    difference: 20000
                    detectedAt: "2025-02-28T10:00:00Z"
                  - type: "STATUS_MISMATCH"
                    platformReservationId: "YNJ-xyz789"
                    systemReservationId: "YNJ-xyz789"
                    platformData:
                      status: "취소"
                    systemData:
                      status: "CONFIRMED"
                    detectedAt: "2025-02-28T10:00:00Z"
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: "RECONCILIATION_PERIOD_TOO_LONG"
                reason: "조회 기간은 최대 31일입니다."
                details:
                  from: "2025-02-01"
                  to: "2025-04-01"
                  requestedDays: 59
                  maxDays: 31
                timestamp: "2025-02-01T10:30:00Z"
                traceId: "abc-123-xyz"

components:
  schemas:
    IncomingEventRequest:
      type: object
      description: 이벤트 요청 바디
      properties:
        eventId:
          type: string
          description: 이벤트 ID (선택)
          example: "evt-001"
        reservationId:
          type: string
          description: 예약 ID (선택)
          example: "res-001"
        payload:
          oneOf:
            - $ref: '#/components/schemas/YanoljaPayload'
            - $ref: '#/components/schemas/AirbnbPayload'
            - $ref: '#/components/schemas/YeogieottaePayload'
          description: 플랫폼별 원본 이벤트 데이터

    YanoljaPayload:
      type: object
      description: |
        야놀자 플랫폼 payload
        - reservationId: YNJ-xxxxxxxx 형식
        - 날짜: yyyy-MM-dd
        - 금액: KRW 정수
        - 상태: 한글 (예약완료, 취소, 노쇼)
        - 시간: yyyy-MM-dd'T'HH:mm:ss (KST)
      properties:
        reservationId:
          type: string
          description: 야놀자 예약 ID
          example: "YNJ-abc123"
        roomId:
          type: string
          description: 객실 ID
          example: "room-001"
        roomName:
          type: string
          description: 객실명
          example: "디럭스 더블"
        accommodationName:
          type: string
          description: 숙소명
          example: "서울 호텔"
        accommodationAddress:
          type: string
          description: 숙소 주소
          example: "서울시 강남구"
        checkInDate:
          type: string
          format: date
          description: 체크인 날짜 (yyyy-MM-dd)
          example: "2025-03-01"
        checkOutDate:
          type: string
          format: date
          description: 체크아웃 날짜 (yyyy-MM-dd)
          example: "2025-03-03"
        stayNights:
          type: integer
          description: 숙박 일수
          example: 2
        guestName:
          type: string
          description: 게스트 이름
          example: "홍길동"
        guestPhone:
          type: string
          description: 게스트 연락처
          example: "010-1234-5678"
        couponCode:
          type: string
          description: 쿠폰 코드
          example: "WELCOME10"
        discountAmount:
          type: integer
          description: 할인 금액 (KRW)
          example: 10000
        totalPrice:
          type: integer
          description: 총 금액 (KRW)
          example: 200000
        paymentMethod:
          type: string
          description: 결제 수단
          example: "CARD"
        status:
          type: string
          description: 예약 상태 (한글)
          enum:
            - 예약완료
            - 취소
            - 노쇼
          example: "예약완료"
        bookedAt:
          type: string
          description: 예약 시각 (KST, yyyy-MM-dd'T'HH:mm:ss)
          example: "2025-02-01T10:30:00"
        platform:
          type: string
          description: 플랫폼명
          example: "YANOLJA"

    AirbnbPayload:
      type: object
      description: |
        에어비앤비 플랫폼 payload
        - confirmationCode: ABC123XYZW 형식
        - 날짜: yyyy-MM-dd (ISO-8601)
        - 금액: double, currency 필드로 통화 지정
        - 상태: 영문 (ACCEPTED, PENDING, CANCELLED, DENIED)
        - 시간: epoch millis
      properties:
        confirmationCode:
          type: string
          description: 에어비앤비 확인 코드
          example: "ABC123XYZW"
        listingId:
          type: string
          description: 리스팅 ID
          example: "listing-001"
        listingName:
          type: string
          description: 리스팅명
          example: "Cozy Studio in Seoul"
        listingAddress:
          type: string
          description: 리스팅 주소
          example: "Seoul, Gangnam"
        checkIn:
          type: string
          format: date
          description: 체크인 날짜 (yyyy-MM-dd)
          example: "2025-03-01"
        checkOut:
          type: string
          format: date
          description: 체크아웃 날짜 (yyyy-MM-dd)
          example: "2025-03-03"
        nights:
          type: integer
          description: 숙박 일수
          example: 2
        guestFirstName:
          type: string
          description: 게스트 이름
          example: "John"
        guestLastName:
          type: string
          description: 게스트 성
          example: "Doe"
        guestEmail:
          type: string
          format: email
          description: 게스트 이메일
          example: "john.doe@example.com"
        numberOfGuests:
          type: integer
          description: 총 게스트 수
          example: 2
        numberOfAdults:
          type: integer
          description: 성인 수
          example: 2
        numberOfChildren:
          type: integer
          description: 어린이 수
          example: 0
        numberOfInfants:
          type: integer
          description: 유아 수
          example: 0
        totalPayout:
          type: number
          format: double
          description: 총 지급액
          example: 150000.0
        hostServiceFee:
          type: number
          format: double
          description: 호스트 서비스 수수료
          example: 5000.0
        guestServiceFee:
          type: number
          format: double
          description: 게스트 서비스 수수료
          example: 3000.0
        cleaningFee:
          type: number
          format: double
          description: 청소비
          example: 10000.0
        currency:
          type: string
          description: 통화
          example: "KRW"
        status:
          type: string
          description: 예약 상태
          enum:
            - ACCEPTED
            - PENDING
            - CANCELLED
            - DENIED
          example: "ACCEPTED"
        cancellationPolicy:
          type: string
          description: 취소 정책
          example: "FLEXIBLE"
        timezone:
          type: string
          description: 타임존
          example: "Asia/Seoul"
        createdAt:
          type: integer
          format: int64
          description: 생성 시각 (epoch millis)
          example: 1706745000000
        updatedAt:
          type: integer
          format: int64
          description: 수정 시각 (epoch millis)
          example: 1706745000000

    YeogieottaePayload:
      type: object
      description: |
        여기어때 플랫폼 payload
        - orderId: YEO-xxxxxxxx 형식
        - 날짜: yyyyMMdd (compact, no dashes)
        - 금액: KRW 정수
        - 상태: 숫자 (1=예약확정, 2=취소, 3=완료, 4=노쇼)
        - 시간: epoch seconds (not millis)
      properties:
        orderId:
          type: string
          description: 여기어때 주문 ID
          example: "YEO-abc123"
        accommodationId:
          type: string
          description: 숙소 ID
          example: "acc-001"
        accommodationName:
          type: string
          description: 숙소명
          example: "부산 호텔"
        accommodationAddress:
          type: string
          description: 숙소 주소
          example: "부산시 해운대구"
        roomTypeId:
          type: string
          description: 객실 타입 ID
          example: "room-type-001"
        roomTypeName:
          type: string
          description: 객실 타입명
          example: "스탠다드"
        startDate:
          type: string
          description: 체크인 날짜 (yyyyMMdd)
          example: "20250301"
        endDate:
          type: string
          description: 체크아웃 날짜 (yyyyMMdd)
          example: "20250303"
        buyerName:
          type: string
          description: 구매자 이름
          example: "김철수"
        buyerTel:
          type: string
          description: 구매자 연락처
          example: "010-9876-5432"
        totalAmount:
          type: integer
          description: 총 금액 (KRW)
          example: 180000
        payMethod:
          type: string
          description: 결제 수단
          example: "CARD"
        state:
          type: integer
          description: 예약 상태 (1=예약확정, 2=취소, 3=완료, 4=노쇼)
          enum:
            - 1
            - 2
            - 3
            - 4
          example: 1
        registeredTs:
          type: integer
          format: int64
          description: 등록 시각 (epoch seconds)
          example: 1706745000
        lastModifiedTs:
          type: integer
          format: int64
          description: 수정 시각 (epoch seconds)
          example: 1706745000

    EventResponse:
      type: object
      description: 이벤트 수신 응답
      required:
        - eventId
        - status
        - message
      properties:
        eventId:
          type: string
          description: 이벤트 고유 ID
          example: "evt-12345"
        status:
          type: string
          description: 처리 상태
          enum:
            - ACCEPTED
            - FAILED
            - SAVED_FOR_RETRY
          example: "ACCEPTED"
        message:
          type: string
          description: 상태 메시지
          example: "이벤트가 정상 처리되었습니다."

    EventListResponse:
      type: object
      description: 이벤트 목록 응답 (페이징)
      required:
        - content
        - page
        - size
        - totalElements
        - totalPages
      properties:
        content:
          type: array
          description: 이벤트 요약 목록 (최신순)
          items:
            $ref: '#/components/schemas/EventSummary'
        page:
          type: integer
          description: 현재 페이지 번호 (0부터 시작)
          example: 0
        size:
          type: integer
          description: 페이지 크기
          example: 20
        totalElements:
          type: integer
          description: 전체 이벤트 수
          example: 156
        totalPages:
          type: integer
          description: 전체 페이지 수
          example: 8

    EventSummary:
      type: object
      description: 이벤트 요약 정보
      required:
        - eventId
        - platform
        - eventType
        - processResult
        - receivedAt
      properties:
        eventId:
          type: string
          description: 이벤트 ID
          example: "evt-12345"
        platform:
          type: string
          description: 플랫폼
          enum:
            - YANOLJA
            - AIRBNB
            - YEOGIEOTTAE
          example: "YANOLJA"
        eventType:
          type: string
          description: 이벤트 타입
          enum:
            - BOOKING
            - CANCELLATION
          example: "BOOKING"
        processResult:
          type: string
          description: 처리 결과
          enum:
            - OK
            - DUPLICATE
            - REJECTED
            - ERROR
          example: "OK"
        reservationId:
          type: string
          description: 예약 ID
          nullable: true
          example: "YNJ-abc123"
        platformRoomId:
          type: string
          description: 플랫폼 객실 ID
          nullable: true
          example: "room-001"
        receivedAt:
          type: string
          format: date-time
          description: 수신 시각
          example: "2025-02-01T10:30:00Z"

    EventDetailResponse:
      type: object
      description: |
        이벤트 처리 상세 결과.
        이 eventId가 시스템의 진실을 어떻게 바꿨는지 보여준다.
      required:
        - eventId
        - platform
        - eventType
        - payload
        - receivedAt
        - processResult
      properties:
        eventId:
          type: string
          description: 이벤트 ID
          example: "evt-12345"
        platform:
          type: string
          description: 플랫폼
          enum:
            - YANOLJA
            - AIRBNB
            - YEOGIEOTTAE
          example: "YANOLJA"
        eventType:
          type: string
          description: 이벤트 타입
          enum:
            - BOOKING
            - CANCELLATION
          example: "BOOKING"
        payload:
          type: object
          description: OTA가 실제로 보낸 원본 payload
        receivedAt:
          type: string
          format: date-time
          description: 이벤트 수신 시각
          example: "2025-02-01T10:30:00Z"
        processedAt:
          type: string
          format: date-time
          description: 이벤트 처리 완료 시각
          nullable: true
          example: "2025-02-01T10:30:01Z"
        processResult:
          type: string
          description: |
            처리 결과
            - OK: 정상 처리
            - DUPLICATE: 중복 이벤트 (무시됨)
            - REJECTED: 비즈니스 규칙에 의해 거부
            - ERROR: 처리 중 오류 발생
          enum:
            - OK
            - DUPLICATE
            - REJECTED
            - ERROR
          example: "OK"
        errorMessage:
          type: string
          description: 에러 메시지 (processResult가 ERROR인 경우)
          nullable: true
          example: null
        reservationId:
          type: string
          description: 영향받은 내부 예약 ID (없으면 null)
          nullable: true
          example: "YNJ-abc123"
        outboxStatus:
          type: string
          description: |
            콜백 전송 상태
            - PENDING: 전송 대기
            - SENT: 전송 완료
            - FAILED: 전송 실패
            - null: 콜백 불필요
          nullable: true
          enum:
            - PENDING
            - SENT
            - FAILED
          example: "SENT"

    InventoryResponse:
      type: object
      description: 재고 조회 응답
      required:
        - roomId
        - startDate
        - endDate
        - inventory
      properties:
        roomId:
          type: string
          description: 객실 ID
          example: "room-001"
        startDate:
          type: string
          format: date
          description: 조회 시작일
          example: "2025-03-01"
        endDate:
          type: string
          format: date
          description: 조회 종료일
          example: "2025-03-07"
        inventory:
          type: array
          description: 날짜별 재고 목록
          items:
            $ref: '#/components/schemas/InventoryEntry'

    InventoryEntry:
      type: object
      description: 날짜별 재고 정보
      required:
        - date
        - total
        - booked
        - available
      properties:
        date:
          type: string
          format: date
          description: 날짜
          example: "2025-03-01"
        total:
          type: integer
          description: 총 재고 (항상 1)
          example: 1
        booked:
          type: integer
          description: 예약된 수량 (0 또는 1)
          example: 0
        available:
          type: integer
          description: 가용 수량 (0 또는 1)
          example: 1

    ReservationStatusResponse:
      type: object
      description: 예약 상태 응답
      required:
        - reservationId
        - platform
        - status
      properties:
        reservationId:
          type: string
          description: 플랫폼별 예약 ID
          example: "YNJ-abc123"
        platform:
          type: string
          description: 플랫폼
          enum:
            - YANOLJA
            - AIRBNB
            - YEOGIEOTTAE
          example: "YANOLJA"
        status:
          type: string
          description: 현재 예약 상태
          enum:
            - PENDING
            - CONFIRMED
            - CANCELLED
            - COMPLETED
            - NOSHOW
          example: "CONFIRMED"
        roomId:
          type: string
          description: 객실 ID
          example: "room-001"
        propertyName:
          type: string
          description: 숙소명
          example: "서울 호텔"
        checkIn:
          type: string
          format: date
          description: 체크인 날짜
          example: "2025-03-01"
        checkOut:
          type: string
          format: date
          description: 체크아웃 날짜
          example: "2025-03-03"
        guestName:
          type: string
          description: 게스트 이름
          example: "홍길동"
        totalAmount:
          type: integer
          description: 총 금액 (KRW)
          example: 200000
        createdAt:
          type: string
          format: date-time
          description: 생성 시각
          example: "2025-02-01T10:30:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 수정 시각
          example: "2025-02-01T10:30:00Z"

    ReservationHistoryResponse:
      type: object
      description: 예약 히스토리 응답
      required:
        - reservationId
        - platform
        - currentStatus
        - history
      properties:
        reservationId:
          type: string
          description: 플랫폼별 예약 ID
          example: "YNJ-abc123"
        platform:
          type: string
          description: 플랫폼
          enum:
            - YANOLJA
            - AIRBNB
            - YEOGIEOTTAE
          example: "YANOLJA"
        currentStatus:
          type: string
          description: 현재 예약 상태
          enum:
            - PENDING
            - CONFIRMED
            - CANCELLED
            - COMPLETED
            - NOSHOW
          example: "CONFIRMED"
        history:
          type: array
          description: 히스토리 목록 (최신순)
          items:
            $ref: '#/components/schemas/ReservationHistoryEntry'

    ReservationHistoryEntry:
      type: object
      description: 히스토리 항목
      required:
        - eventId
        - eventType
        - result
        - occurredAt
      properties:
        eventId:
          type: string
          description: 이벤트 ID
          example: "evt-001"
        eventType:
          type: string
          description: 이벤트 타입
          enum:
            - BOOKING
            - CANCELLATION
          example: "BOOKING"
        result:
          type: string
          description: 처리 결과
          enum:
            - SUCCESS
            - FAILED
          example: "SUCCESS"
        previousStatus:
          type: string
          description: 이전 상태 (첫 이벤트인 경우 null)
          nullable: true
          enum:
            - PENDING
            - CONFIRMED
            - CANCELLED
            - COMPLETED
            - NOSHOW
          example: null
        newStatus:
          type: string
          description: 변경된 상태
          enum:
            - PENDING
            - CONFIRMED
            - CANCELLED
            - COMPLETED
            - NOSHOW
          example: "CONFIRMED"
        errorMessage:
          type: string
          description: 실패 시 에러 메시지
          nullable: true
          example: null
        occurredAt:
          type: string
          format: date-time
          description: 발생 시각 (ISO-8601)
          example: "2025-02-01T10:30:00Z"

    ErrorResponse:
      type: object
      description: |
        구조화된 에러 응답.

        ## 에러 코드 체계

        ### Events
        | 코드 | 설명 |
        |------|------|
        | EVENT_NOT_FOUND | 이벤트를 찾을 수 없음 |
        | EVENT_PARSE_ERROR | 이벤트 파싱 실패 |
        | INVALID_PLATFORM | 지원하지 않는 플랫폼 |
        | INVALID_EVENT_TYPE | 지원하지 않는 이벤트 타입 |

        ### Reservations
        | 코드 | 설명 |
        |------|------|
        | RESERVATION_NOT_FOUND | 예약을 찾을 수 없음 |
        | DUPLICATE_RESERVATION | 중복 예약 |
        | RESERVATION_ALREADY_CANCELLED | 이미 취소된 예약 |

        ### Inventory / Processing (FailureReason)
        | 코드 | 설명 |
        |------|------|
        | UNKNOWN_ROOM | 플랫폼 방 매핑을 찾을 수 없음 |
        | NOT_AVAILABLE | 해당 기간 재고 불가 |
        | ROOM_ALREADY_BOOKED | 이미 예약된 객실 |
        | ROOM_NOT_FOUND | 객실을 찾을 수 없음 |
        | INVALID_DATE_RANGE | 잘못된 날짜 범위 |

        ### Idempotency
        | 코드 | 설명 |
        |------|------|
        | IDEMPOTENCY_KEY_NOT_FOUND | 멱등성 키 없음 |

        ### Reconciliation
        | 코드 | 설명 |
        |------|------|
        | RECONCILIATION_PERIOD_TOO_LONG | 조회 기간 초과 |

        ### 공통
        | 코드 | 설명 |
        |------|------|
        | INTERNAL_ERROR | 내부 서버 오류 |
        | VALIDATION_ERROR | 유효성 검증 실패 |
        | UNAUTHORIZED | 인증 실패 |
        | FORBIDDEN | 권한 없음 |
      required:
        - code
        - reason
        - timestamp
        - traceId
      properties:
        code:
          type: string
          description: 에러 코드
          example: "NOT_AVAILABLE"
        reason:
          type: string
          description: 에러 사유 (사람이 읽을 수 있는 메시지)
          example: "해당 기간에 가용 재고가 없습니다."
        details:
          type: object
          description: 에러 상세 정보 (선택)
          nullable: true
          example:
            roomId: "room-001"
            requestedDate: "2025-03-01"
            availableFrom: "2025-03-05"
        timestamp:
          type: string
          format: date-time
          description: 에러 발생 시각
          example: "2025-02-01T10:30:00Z"
        traceId:
          type: string
          description: 요청 추적 ID (디버깅/문의용)
          example: "abc-123-xyz-456"

    IdempotencyResponse:
      type: object
      description: |
        멱등성 키 응답.
        Exactly-once 보장의 증거 레지스트리.
      required:
        - eventId
        - firstProcessedAt
        - result
        - resultHash
      properties:
        eventId:
          type: string
          description: 이벤트 ID
          example: "evt-12345"
        firstProcessedAt:
          type: string
          format: date-time
          description: 최초 처리 시각
          example: "2025-02-01T10:30:00Z"
        result:
          type: string
          description: |
            처리 결과
            - CONFIRMED: 정상 처리되어 효과 발생
            - REJECTED: 비즈니스 규칙에 의해 거부
            - IGNORED: 중복으로 무시됨
          enum:
            - CONFIRMED
            - REJECTED
            - IGNORED
          example: "CONFIRMED"
        reservationId:
          type: string
          description: 만들어진 예약 ID (없으면 null)
          nullable: true
          example: "YNJ-abc123"
        resultHash:
          type: string
          description: 결과 payload 해시 (동일 요청 재처리 시 동일 응답 보장 검증용)
          example: "a1b2c3d4e5f6..."

    ReconciliationResponse:
      type: object
      description: 대사 리포트 응답
      required:
        - platform
        - period
        - summary
        - discrepancies
      properties:
        platform:
          type: string
          description: 플랫폼
          enum:
            - YANOLJA
            - AIRBNB
            - YEOGIEOTTAE
          example: "YANOLJA"
        period:
          type: object
          description: 조회 기간
          required:
            - from
            - to
          properties:
            from:
              type: string
              format: date
              description: 시작일
              example: "2025-02-01"
            to:
              type: string
              format: date
              description: 종료일
              example: "2025-02-28"
        summary:
          $ref: '#/components/schemas/ReconciliationSummary'
        discrepancies:
          type: array
          description: 불일치 상세 목록
          items:
            $ref: '#/components/schemas/ReconciliationDiscrepancy'

    ReconciliationSummary:
      type: object
      description: 대사 요약
      required:
        - totalPlatformRecords
        - totalSystemRecords
        - matchedCount
        - discrepancyCount
        - byType
      properties:
        totalPlatformRecords:
          type: integer
          description: 플랫폼 측 총 레코드 수
          example: 150
        totalSystemRecords:
          type: integer
          description: 시스템 측 총 레코드 수
          example: 148
        matchedCount:
          type: integer
          description: 일치 건수
          example: 145
        discrepancyCount:
          type: integer
          description: 불일치 건수
          example: 5
        byType:
          type: object
          description: 불일치 유형별 건수
          properties:
            MISSING_IN_SYSTEM:
              type: integer
              description: 플랫폼에만 있고 시스템에 없음
              example: 2
            MISSING_IN_PLATFORM:
              type: integer
              description: 시스템에만 있고 플랫폼에 없음
              example: 0
            AMOUNT_MISMATCH:
              type: integer
              description: 금액 불일치
              example: 1
            STATUS_MISMATCH:
              type: integer
              description: 상태 불일치
              example: 2
            DATE_MISMATCH:
              type: integer
              description: 날짜 불일치
              example: 0

    ReconciliationDiscrepancy:
      type: object
      description: 불일치 상세 정보
      required:
        - type
        - detectedAt
      properties:
        type:
          type: string
          description: 불일치 유형
          enum:
            - MISSING_IN_SYSTEM
            - MISSING_IN_PLATFORM
            - AMOUNT_MISMATCH
            - STATUS_MISMATCH
            - DATE_MISMATCH
          example: "AMOUNT_MISMATCH"
        platformReservationId:
          type: string
          description: 플랫폼 예약 ID
          nullable: true
          example: "YNJ-abc123"
        systemReservationId:
          type: string
          description: 시스템 예약 ID
          nullable: true
          example: "YNJ-abc123"
        platformData:
          type: object
          description: 플랫폼 측 데이터 (불일치 필드만)
          nullable: true
        systemData:
          type: object
          description: 시스템 측 데이터 (불일치 필드만)
          nullable: true
        difference:
          type: number
          description: 차이값 (금액 불일치인 경우)
          nullable: true
          example: 20000
        detectedAt:
          type: string
          format: date-time
          description: 감지 시각
          example: "2025-02-28T10:00:00Z"
